\documentclass[a4paper]{report}

\usepackage{polski}
\usepackage[utf8]{inputenc}
\usepackage[polish]{babel}
\usepackage[pdftex]{graphicx}
\usepackage[pdftex]{hyperref}
\usepackage{mdwlist}
\usepackage{bm}

\begin{document}

\title{Specyfikacja wymagań dla systemu telemedycznego realizowanego w ramach projektu ,,Telemedycyna – element e-zdrowia WZP''}
\author{Zespół Projektowy}
\date{25/06/2012}
\maketitle

\tableofcontents

\chapter{Założenia ogólne}

Od strony funkcjonalnej System składa się z dwóch niezależnych podsystemów działających na tej samej platformie sprzętowej i programowej: Podsystem Elektronicznego Zlecania Opisów Badań Medycznych (zwany danej Systemem Zlecania) oraz Podsystem Elektronicznej Wymiany Danych Medycznych (zwany dalej Bazą Metadanych).

Słownik określeń wspólnych dla obu systemów:
\begin{description}
\item[System] Centralny system telemedyczny, będący przedmiotem tej specyfikacji.
\item[Węzeł centralny] Serwer lub grupa serwerów znajdująca się w siedzibie zamawiającego; węzeł centralny posiada informacje o węzłach lokalnych i ma stałą łączność z nimi.
\item[Węzeł lokalny] Serwer znajdujący się w siedzibie użytkownika (w szpitalu); węzeł lokalny ma łączność z węzłem centralnym; innymi węzłami lokalnymi oraz z LSS.
\item[LSS] Lokalne systemy szpitalne -- wewnętrzne systemy funkcjonujące w danej jednostce medycznej, typu PACS, HIS, RIS; komunikacja Systemu z nimi odbywa się za pomocą protokołów DICOM oraz HL7.
\item[Interfejs webowy] Interfejs użytkownika dostępny zdalnie za pomocą przeglądarki WWW.
\end{description}

\section{Architektura fizyczna}
\label{sec:arch_fiz}

System działa na szeregu węzłów połączonych w topologii częściowej siatki. Rozróżnia się 2 rodzaje węzłów: centralny i lokalny. W sieci, zwanej konfederacją, występuje jeden węzeł centralny i wiele węzłów lokalnych. 

\subsection{Węzeł centralny}
Węzeł centralny może składać się z maksymalnie 4 serwerów fizycznych lub maksymalnie 6 serwerów zwirtualizowanych działających na 4 serwerach fizycznych i na tych zasobach sprzętowych musi zapewniać taką niezawodność, że awaria jednego serwera fizycznego nie powoduje utraty funkcjonalności Systemu. Obsługa awarii pojedynczego serwera musi być tak zrealizowana, że przerwa w działaniu węzła centralnego nie będzie dłuższa niż 5 minut.

Węzeł centralny ma łączność z Internetem i jest widoczny pod publicznym adresem IP. Węzeł centralny poprzez Internet komunikuje się ze wszystkimi węzłami lokalnymi. Zarządzanie węzłem centralnym odbywa się poprzez niezależny od pozostałych węzłów interfejs webowy.

\subsection{Węzeł lokalny}
Węzeł lokalny musi być możliwy do uruchomienia na pojedynczym serwerze fizycznym lub zwirtualizowanym z zainstalowanym systemem operacyjnym Debian GNU/Linux w wersji 6.0 lub nowszej i ma łączność z LSS oraz z Internetem. Na styku z Internetem jest widoczny pod publicznym adresem IP. Każdy węzeł lokalny poprzez Internet komunikuje się z węzłem centralnym i wybranymi węzłami lokalnymi.

\section{Bezpieczeństwo}
\begin{enumerate}
 \item Węzeł centralny oraz węzły lokalne muszą być dwojako zabezpieczone:
    \begin{enumerate}
    \item wszystkie interfejsy zewnętrzne (interfejs użytkownika, zdalne API itp.) muszą posiadać zabezpieczenia pozwalające na kontrolę dostępu do nich za pomocą odpowiednich mechanizmów uwierzytelniania i autoryzowania; komunikacja z interfejsami zewnętrznymi odbywa się poprzez połączenia szyfrowane; mechanizmy te muszę zapewniać pełne bezpieczeństwo niezależne od zabezpieczenia drugiego,
    \item dostęp do interfejsów zewnętrznych jest kontrolowany za pomocą zapory ogniowej serwera udostępniającego dany interfejs; zapora ogniowa udostępnia interfejsy zewnętrzne tylko niezbędnym programom klienckim.
    \end{enumerate}
 \item Oba podsystemy korzystają ze wspólnej bazy użytkowników, tak aby użytkownik uwierzytelniając się za pomocą tych samych danych mógł korzystać z obu podsystemów, jeśli ma to tego uprawnienia.
 \item Jeden profil użytkownika zawiera atrybuty specyficzne zarówno dla jednego, jak i drugiego podsystemu.
\end{enumerate}

\section{Ochrona danych osobowych}

Węzeł centralny nie gromadzi i nie przetwarza danych osobowych ani danych wrażliwych. Węzły lokalne, będące pod zarządem jednostek medycznych, u których są zainstalowane, mogą przetwarzać dane osobowe.

\section{Rejestracja przebiegu procesów oraz raportowanie}

Przebieg wszystkich procesów realizowanych przez węzły lokalne oraz węzeł 
centralny musi być rejestrowany w sposób umożliwiający: 
\begin{enumerate}
  \item prowadzenie rozliczeń finansowych pomiędzy zlecającymi i konsultantami,
  \item przeprowadzenie audytu poprawności przebiegu procesów,
  \item stwierdzenie kto, kiedy i jakie dane modyfikował, a w przypadku dostępu do danych
  jednostki zewnętrznej, również fakt przeglądania danych medycznych.
  \item eksport zebranych danych do uniwersalnych formatów takich jak: CSV i XML.
\end{enumerate}

\section{Cechy interfejsu użytkownika}

\begin{enumerate}
  \item Zasady weryfikacja poprawności danych wprowadzanych do formularzy, o ile
  nie wyspecyfikowano tego inaczej dla konkretnego pola, są następujące:
  \begin{enumerate}
    \item weryfikacja pola odbywa się bezpośrednio po zakończeniu wprowadzania zmian do pola, czyli utracie przez pole skupienia (fokusu)
    lub inna możliwość: weryfikacja pola odbywa się po utracie skupienia lub po upływie konfigurowalnego czasu od ostatniej zmiany zawartości pola,
    \item efekty weryfikacji poprawności danego pola są prezentowane bezpośrednio przy polu w sposób nie angażujący użytkownika do wykonania
    akcji (np. zatwierdzenia komunikatu poprzez kliknięcie),
    \item efekty weryfikacji powinny być tak prezentowane, aby użytkownik mógł szybko określić, które pola mają
    nieprawidłową treść (użycie odpowiednich kolorów w celu oznaczenia prawidłowych i nieprawidłowych pól oraz towarzyszących
    im komunikatów),
    \item jeśli formularz zawiera pola z nieprawidłowymi danymi, to użytkownik nie może wywołać akcji, dla której dostarcza on dane.
  \end{enumerate}

  \item Możliwość zdefiniowania wyglądu interfejsu użytkownika za pomocą CSS (Cascading Style Sheets).

  Wszystkie pliki \emph{css} muszą znajdować się w specjalnie do tego przeznaczonym katalogu (i ewentualnie
  jego podkatalogach) oraz być dostępne dla administratora węzła do modyfikacji. Z nazw plików musi wynikać
  ich przeznaczenie. Używane nazwy klas i identyfikatory obiektów muszą być w miarę możliwości czytelne
  dla człowieka. Dokumentacja do Systemu musi opisywać, które klasy i identyfikatory do czego służą.

  \item Możliwość określenia bogato sformatowanej treści, która pojawia się jako pierwszy ekran systemu
  i zawiera formularz logowania do systemu lub w przypadku uwierzytelniania za pomocą certyfikatów X.509,
  przycisk wejścia do systemu.

\subsection{Interfejs administracyjny węzła lokalnego}

Interfejs administracyjny musi posiadać następującą funkcjonalność:
\begin{enumerate}
  \item W ramach zarządzania użytkownikami administrator musi mieć możliwość:
    \begin{enumerate}
      \item dodawania, modyfikowania, usuwania i blokowania użytkowników; zablokowany użytkownik nie traci żadnych swoich ustawień, ale nie może zalogować się do systemu,
      \item ustalania uprawnień użytkowników,
      \item zmiany hasła użytkowników lub innych parametrów związanych z uwierzytelnianiem (np. DN certyfikatu X.509, którym użytkownik się uwierzytelnia).
    \end{enumerate}

  \item System może być źródłem trzech typów komunikatów, których obsługa jest realizowana poprzez interfejs użytkownika:
    \begin{description}
      \item[Alerty] komunikaty o najwyższym priorytecie - są generowane programowo i sygnalizują wystąpienie sytuacji potencjalnie groźnych. Np wystąpienie dwóch różnych nazwisk przypisanych w różnych węzłach lokalnych do tego samego numeru PESEL może być efektem pomyłki i grozić utratą integralności danych. W klasie alertów mieszczą się też komunikaty o błędach w działaniu oprogramowania. Komunikaty o błędach w miarę możliwości powinny zawierać informację pozwalającą szybko zidentyfikować ich charakter (np. źródło, nr linii, kod błędu itp.), TODO: jeśli to ma być w interfejsie użytkownika/administratora, to raczej powinna chyba się pojawić nazwa modułu, jego funkcji i zrozumiały opis problemu,

      \item[Ostrzeżenia] komunikaty o średnim priorytecie sygnalizują nieprawidłowości w działaniu systemu - np. przeterminowanie badania, brak połączenia pomiędzy węzłami itp. Ostrzeżenia dotyczą wydarzeń mniejszej wagi niż alerty. Nie niosą informacji o zdarzeniach zagrażających stabilności systemu. Ostrzeżenia również tworzono są programowo. TODO Maciej: czy przeterminowanie badania, to nieprawidłowość w działaniu systemu?

      \item[Zawiadomienia] komunikaty wysyłane przez użytkowników systemu, którzy mogą dowolnie zdefiniować ich treść. Wysłanie zawiadomienia powinno być możliwe z każdego poziomu interfejsu. W miarę możliwości powinien istnieć mechanizm umożliwiający użytkownikowi intuicyjny sposób zgłoszenia sytuacji awaryjnej (np. wykonanie zrzutu ekranu). TODO Maciej: z poziomu web raczej nie można zrobić screenshota
    \end{description}

\end{enumerate}

\subsection{Interfejs administracyjny węzła centralnego}

Interfejs administracyjny musi umożliwiać przeprowadzenie następujących czynności:
\begin{enumerate}
  \item Aplikacja węzła centralnego powinna prezentować listę komunikatów w przejrzysty sposób, z możliwością filtrowania przynajmniej po dacie, treści i typie. Powinien istnieć mechanizm oznaczania i ukrywania komunikatów ,,obsłużonych''
\end{enumerate}

\end{enumerate}

\section{Konfigurowalność}

TODO Seweryn: zmienić sekcję konfigurowalność na mapowanie

\subsection{Komunikacja HL7}

TODO Seweryn: wyekstrahować wspólne cechy obu mapowań i przenieść do nadrzędnej sekcji

Interfejs komunikacji HL7 musi umożliwiać mapowane pól komunikatów HL7 jeden do wielu. Oznacza to, że przychodzący komunikat HL7, niezależnie od systemu nadawcy, może zostać przetłumaczony na wewnętrzną strukturę danych systemu. Konfiguracja mapowań musi być możliwa do przeniesienia pomiędzy węzłami. Konfiguracja mapowań powinna być zapisana w plikach konfiguracyjnych zrozumiałych dla użytkownika.

TODO Seweryn: przenieść opis modułu udostępniania do systemu metadanych i rozwinąć go
Moduł udostępniania opisów w węźle lokalnym można konfigurować poprzez definicje URI, zakresu odpowiedzi i formy odpowiedzi (format HTML, XML). Konfiguracja (np. w zakresie formatowania odpowiedzi) może być dynamiczna na podstawie URI. 

\subsection{Mapowanie tagów DICOM}

Komunikacja z lokalnymi systemami szpitalnymi LSS za pomocą protokołu DICOM musi obsługiwać możliwość elastycznego konfigurowania mapowania wartości zapisanych w tagach DICOM na wewnętrzne struktury danych systemu. Mapowanie powinno umożliwiać wskazanie pola (tagu) pliku DICOM, które zawiera interesujące dane i przypisanie go do określonego pola w wewnętrznej strukturze danych systemu wraz z określeniem przetwarzania wartości poprzez:
\begin{enumerate}
  \item użycie wyrażeń regularnych do modyfikacji wartości pola,
  \item określenie słownika mapującego określone słowa kluczowe występujące w polu pliku DICOM na odpowiadające im słowa kluczowe zdefiniowane w wewnętrznej strukturze danych systemu.
\end{enumerate}

Mapowanie musi działać w obu kierunkach, tzn. zarówno kiedy plik DICOM importowany jest z LSS, jak i kiedy jest do niego eksportowany.

Konfiguracja mapowań musi być możliwa do przeniesienia pomiędzy węzłami. Konfiguracja mapowań powinna być zapisana w plikach konfiguracyjnych zrozumiałych dla użytkownika.

Musi też istnieć mechanizm filtrowania, dzięki któremu będzie można określić, jakie reguły mapujące mają być użyte, w zależności od wartości określonych pól pliku DICOM, bądź wewnętrznej struktury danych systemu (odpowiednio przy imporcie i eksporcie danych). Ma to na celu umożliwienie stosowania różnych mapowań np. w zależności od tego z jakiego źródła plik DICOM pochodzi.

W szczególności, mapowanie ma umożliwić automatyczne wypełnianie wszystkich możliwych pól zlecenia (np. pola typ badania) po załączeniu do niego wyników badania, używając do tego celu dane pozyskane z plików DICOM tego badania. Przy pozyskiwaniu danych z plików DICOM powinno się ograniczyć do niezbędnego minimum ilość zapytań do LSS i ilość ściągniętych plików.

%--------------------------------------------------------------------------------------------
%--------------------------------------------------------------------------------------------
\chapter[Podsystem Elektronicznego Zlecania Opisów Badań]{Wymagana funkcjonalność Podsystemu Elektronicznego Zlecania Opisów Badań Medycznych}

Zadaniem podsystemu jest umożliwienie użytkownikom węzłów lokalnych zlecanie między sobą opisów
badań medycznych oraz odbiór gotowych opisów. Zlecenia wysyłane są do węzła centralnego, który
dystrybuuje je do węzłów lokalnych konsultantów. Zlecenie stanowi pakiet danych zawierający
treść zlecenia oraz pliki będące wynikiem badania, które ma zostać opisane. 

Słownik określeń specyficznych dla Systemu Zlecenia
\begin{description}
  \item[Zleceniodawca] Użytkownik węzła lokalnego zlecający do systemu wykonanie opisu badania.
  \item[Konsultant] Użytkownik węzła lokalnego realizujący zlecenie opisu badania, które pojawiło się na jego węźle.
  \item[Zlecenie] Zlecenie opisu badania medycznego.
\end{description}

\section{Definicja zlecenia}

Zlecenie jest dokumentem elektronicznym zawierającym opis zlecenia wraz z niezbędnymi atrybutami oraz listę załączonych dokumentów elektronicznych. Zlecenie i załączone dokumenty muszą być identyfikowane w sposób jednoznaczny w skali globalnej (w Internecie). Musi istnieć również mechanizm pozwalający dowolnemu węzłowi na samodzielne zlokalizowanie dokumentu na podstawie jego identyfikatora i pobieranie go, jeśli węzeł jest do tego uprawniony. Zamawiający zaleca stosowanie URI do identyfikacji zlecenia i załączonych dokumentów.

Zlecenie powinno posiadać co najmniej następujące atrybuty:
\begin{enumerate*}
\item globalnie unikatowy identyfikator zlecenia,
\item dane identyfikujące zleceniodawcę,
\item dane kontaktowe zleceniodawcy,
\item datę wykonania badania,
\item listę załączników,
\item zanonimizowane dane o pacjencie, takie jak wiek, płeć,
\item treść definiującą co ma być opisane,
\item określenie uporządkowanej listy odbiorców zlecenia,
\item określenie nazwy usługi (pakietu usług) do której zlecenie jest kierowane,
\item określenie typu badania,
\item określenie modalności,
\item określenie czasu na wykonanie opisu badania (z dokładnością do co najmniej 1 minuty),
\item określenie schematu powiadamiania węzłów konsultantów o zgłoszonym zleceniu,
\item określenie ilości i długości możliwych przedłużeń czasu na wykonanie badania.
\end{enumerate*}

Pakiet usług jest definiowany na węźle lokalnym zleceniodawcy. Pakiet usług predefiniuje listę konsultantów i wybrane atrybuty zlecenia. Patrz \ref{zlecenia-konfig}

Wymagana jest implementacja co najmniej 2 schematów powiadamiania węzłów konsultantów o zgłoszonym zleceniu:
\begin{enumerate}
 \item pojedynczo -- węzły konsultantów powiadamiane są pojedynczo w kolejności określonej w zleceniu,
 \item wszyscy -- powiadamiane są jednocześnie wszystkie węzły konsultantów określone w zleceniu.
\end{enumerate}

\section{Wymagania ogólne}
\begin{enumerate}
\item Powiadamianiem węzłów konsultantów o zgłoszonych zleceniach zajmuje się węzeł centralny.
\item Na węźle centralnym nie pojawiają się dane wrażliwe i osobowe.
\item W celu wymiany danych wrażliwych węzły lokalne komunikują się bezpośrednio między sobą.
\item Komunikaty sygnalizacyjne informujące o przebiegu obsługi zlecenia przechodzą przez węzeł centralny.
\item Węzeł centralny gromadzi pełną wiedzę zarówno o aktualnie przetwarzanych zleceniach, jak i o zleceniach przetworzonych w przeszłości.
\item Dostęp do definicji zlecenia i załączonych do niego dokumentów mają tylko węzły konsultantów określone przez zleceniodawcę. Dostęp ten odbywa się w sposób i w kolejności określonej przez zleceniodawcę.
\end{enumerate}

\section{Przetwarzanie zleceń}

Elementy silnika przetwarzania zleceń znajdują się na wszystkich węzłach.

Funkcje silnika przetwarzania zleceń:
\begin{enumerate}
  \item niezawodne dostarczanie zleceń do właściwych konsultantów,
  \item dbanie aby do zleceń miały dostęp tylko uprawnione osoby,
  \item transferowanie do węzłów konsultantów dokumentów załączonych do zlecenia w sposób zoptymalizowany pod kątem jak najszybszego uzyskania opisu badania,
  \item dbanie aby dane zlecenie mogło być w jednym momencie opisywane tylko przez jednego konsultanta,
  \item dbanie aby zlecenia o krótkim czasie na wykonanie opisu, miały przy transferowaniu wyższy priorytet niż zlecenia o długim czasie na wykonanie opisu,
  \item reagowanie na przekroczenie przez konsultanta czasu na wykonanie opisu badania poprzez umożliwienie wykonania opisu badania kolejnemu konsultantowi,
  \item umożliwienie konsultantowi, który przekroczył czas na wykonanie opisu badania, dokonania przedłużenia czasu (ilość i długość możliwych przedłużeń jest definiowana w zleceniu),
  \item umożliwienie konsultantowi podjęcie opisywania zlecenia przed całkowitym zakończeniem transferu zlecenia,
  \item umożliwienie konsultantowi dostęp (również w LSS) do przesłanych dokumentów zlecenia, nim cały komplet dokumentów zostanie przesłany,
  \item po stronie zleceniodawcy:
  \begin{enumerate}
    \item ogłaszanie utworzenia zlecenia, 
    \item udostępnianie zleceń wraz z załącznikami dla węzłów konsultantów,
    \item pozyskiwanie gotowych opisów badań od konsultantów,
    \item monitorowanie przebiegu procesu wysyłania zlecenia w celu prezentacji wyników poprzez interfejs użytkownika, 
    \item monitorowanie stanu zlecenia w celu jego prezentacji poprzez interfejs użytkownika,
  \end{enumerate}
  \item po stronie konsultanta:
  \begin{enumerate}
    \item przyjmowanie zleceń,
    \item monitorowanie przebiegu procesu odbierania zlecenia w celu prezentacji wyników poprzez interfejs użytkownika,
    \item przekazanie danych związanych ze zleceniem do LSS,
    \item informowanie zainteresowanych węzłów o przebiegu realizacji zlecenia,
    \item udostępnienie gotowego opisu badania dla zleceniodawcy.
  \end{enumerate}
\end{enumerate}

Optymalizacja transferu zleceń pod kątem jak najszybszego uzyskania opisu badania powinna być realizowana poprzez realizację następujących zasad:
\begin{enumerate}
 \item węzły starają się w pełni wykorzystać przepustowość łączy między sobą,
 \item węzły starają się najpierw przesłać jedno kompletne zlecenie nim zaczną przesyłać następne,
 \item o ile jest taka potrzeba, to wskazane jest transferowanie więcej niż jednego zlecenia równolegle, jeśli uruchomienie nowego transferu nie powoduje pogorszenia transferu już przesyłanych zleceń,
 \item jeśli transferowane są zlecenia o długim czasie na wykonanie opisu i pojawi się nowe zlecenie, o krótkim czasie na wykonanie opisu, to transfer zleceń o długim czasie na wykonanie opisu powinien być wstrzymany, jeśli poprawiłoby to transfer zlecenia o krótkim czasie na wykonanie opisu.
\end{enumerate}

\section{Interfejs użytkownika}

Wymagany jest webowy interfejs użytkownika do realizacji wszystkich podstawowych funkcji systemu. Możliwe jest zastosowanie również dodatkowych niewebowych interfejsów użytkownika. Każdy z węzłów lokalnych oraz węzeł centralny muszą mieć swoje własne interfejsy użytkownika.

Wymagania dla webowego interfejsu użytkownika:

\begin{enumerate}
    \item Co najmniej 3 poziomy dostępu do interfejsu użytkownika:
        \begin{enumerate}
        \item technik -- może tworzyć zlecenia, ale nie może ich wysłać,
        \item zleceniodawca -- uprawnienia technika powiększone o możliwość wysyłania zleceń,
        \item administrator -- ma możliwość zmiany konfiguracji systemu i ingerencji w dane poza produkcyjnym schematem działania.
        \end{enumerate}
    \item neutralność technologiczna zapewniona poprzez:
	  \begin{enumerate}
            \item poprawne działanie na najnowszej na dzień ogłoszenia przetargu wersji popularnych przeglądarek WWW, co najmniej takich jak: MS Internet Explorer, Mozilla Firefox oraz Google Chrome,
            \item realizację wszystkich podstawowych funkcji interfejsu użytkownika bez wymagania jakichkolwiek dodatków do przeglądarek, czy używania funkcji przeglądarek specyficznych dla określonego systemu operacyjnego, na którym przeglądarka działa.
	  \end{enumerate}
    \item sprawność działania zapewniona poprzez:
	  \begin{enumerate}
          \item automatyczne wypełnianie pól w formularzach danymi znanymi lub prawdopodobnymi, w szczególności:
            \begin{enumerate}
              \item automatyczne wstawianie prawdopodobnych dat,
              \item automatyczne wypełnianie danych zlecenia danymi zawartymi w załączanych plikach DICOM,
              \item automatyczne wstawianie ostatnio użytej wartości w polach, których jest to uzasadnione,
            \end{enumerate}
	  \item takie zaprojektowanie interfejsu, aby zminimalizować ilość interakcji z użytkownikiem -- minimalizacja ilości kliknięć wymaganych do wykonania określonej czynności oraz ilość wprowadzanych ręcznie przez użytkownika danych,
	  \item takie zaprojektowanie interfejsu, aby zminimalizować czas reakcji interfejsu na akcję użytkownika - interfejs użytkownika musi sprawnie działać w przeglądarce uruchomionej na komputerze z procesorem o wydajności PassMark wynoszącej 200O i 380 MB pamięci RAM dostępnej dla przeglądarki, w szczególności:
            \begin{enumerate}
              \item użytkownik musi natychmiast widzieć reakcję systemu na wykonane przez niego działanie (kliknięcie myszą w link/przycisk, wciśnięcie klawisza),
              \item przebieg wykonywania działań rutynowych powinien być tak zaprojektowany, aby żaden z kroków nie wymagał oczekiwania na uzyskanie rezultatu dłużej niż 2 sekundy,
              \item procesy, które trwają dłużej niż 2 sekundy powinny mieć pasek postępu informujący użytkownika o przebiegu procesu,
              \item procesy, które trwają dłużej niż 30 sekund powinny być wykonywane w tle, a użytkownik powinien móc sprawdzać ich stan i w dowolnej chwili po zakończeniu mieć dostęp do rezultatów.
            \end{enumerate}
	  \end{enumerate}
\end{enumerate}

Podstawowe funkcje interfejsu użytkownika:
\begin{enumerate}
  \item Tworzenie zlecenia:
      \begin{enumerate}
      \item Przy tworzeniu zlecenia użytkownik musi mieć możliwość dostarczenia kompletnej definicji zlecenia (patrz opis treści zlecenia).
      \item Użytkownik musi mieć możliwość załączenia do zlecenia plików z wynikami badań oraz innych plików (np. skan  skierowania na badanie); wymagana jest obsługa 3 sposobów dostarczania plików: wybór pliku z zasobów dyskowych dostępnych w systemie operacyjnym, na którym działa przeglądarka, wybór pliku znajdującego się w buforze plików DICOM na węźle lokalnym, uruchomienie wyszukiwarki plików w systemie PACS, a następnie pobranie wybranych przez użytkownika plików do bufora i automatyczne załączenie ich do zlecenia.
      \end{enumerate}
  \item Wysyłanie zlecenia:
      \begin{enumerate}
      \item Wybranie załącznika w formacie DICOM powinno automatycznie ustawiać pole "`kod badania"'. Pole to musi być edytowalne dla użytkownika.
      \item Ustawienie pola "`kod badania"' powinni automatycznie wypełniać pole selekcji "`pakietu usług"' tylko tymi pakietami usług, które obsługują wybrany wcześniej kod badania.
      \item Wybranie pakietu usług automatycznie ustawia czas na wykonanie badania i w zależności od konfiguracji pakietu, czas ten użytkownik może zmienić lub nie.
      \item Wybranie pakietu usług automatycznie ustawia również listę węzłów konsultantów i w zależności od konfiguracji pakietu, użytkownik może wybrać konsultanta, do którego w pierwszej kolejności badanie będzie wysłane, lub nie.
      \end{enumerate}
  \item Prezentacja:
    \begin{enumerate}
      \item listy bieżących zleceń, zawierającej:
	  \begin{enumerate}
	  \item bieżący stan transferu zleceń w postaci ilości serii/łączna liczba serii i ilości obrazów w każdej serii u wszystkich zainteresowanych stron,
	  \item meta dane zlecenia (Imię, Nazwisko, Pesel/Data urodzenia, modalność, kod badania, data i godzina badania, czas do którego należy dokonać opisu, uwagi do badania),
	  \end{enumerate}
      \item listy archiwalnych zleceń z możliwością przeszukiwania za pomocą dat oraz danych pacjenta.
    \end{enumerate}

\end{enumerate}

\section{Schemat pracy}
\begin{enumerate}
\item Użytkownik łączy się przeglądarką WWW z lokalnym interfejsem Systemu, loguje się do niego i ma możliwość:
        \begin{enumerate}
        \item przejrzenia stanu aktualnych (będących w trakcie przetwarzania) zleceń,
        \item przeglądania zleceń archiwalnych,
        \item modyfikacji aktualnych, niezakończonych zleceń,
        \item stworzenia nowego zlecenia,
        \item wysłania gotowego zlecenia,
        \item realizacji zlecenia (opisania badania).
        \end{enumerate}
\item W ramach tworzenia/modyfikacji zlecenia użytkownik może:
        \begin{enumerate}
        \item wybrać pliki DICOM (pogrupowane np. wg. StudyUID, albo nazwy pacjenta) znajdujące się w buforze na węźle (pliki do bufora trafiają w wyniku wysłania ich do węzła z poziomu systemu PACS),
        \item wyszukać i pobrać pliki DICOM bezpośrednio z PACS,
        \item wysłać poprzez interfejs web plik istniejący na terminalu użytkownika,
        \item zmodyfikować wszystkie istotne na tym etapie parametry zlecenia,
        \item przy tworzeniu zlecenia, kod badania jest automatycznie ustawiany na podstawie tagów z pierwszego wybranego pliku DICOM (patrz \ref{zlecenia-konfig}),
        \item ustawienie kodu badania determinuje listę dostępnych pakietów usług,
        \item wybranie konkretnego pakietu usług determinuje listę konsultantów,
        \item w zależności od konfiguracji pakietu, zleceniodawca może mieć możliwość wybrania węzła konsultanta, do którego zlecenie będzie transferowane w pierwszej kolejności.
        \end{enumerate}
\end{enumerate}

\section{Integracja węzłów lokalnych z lokalnymi systemami szpitalnymi}

Węzeł lokalny musi mieć możliwość komunikacji z lokalnym systemem PACS w celu:
\begin{enumerate}
 \item po stronie zleceniodawcy: pozyskania wyników badania, które ma być opisane,
 \item po stronie konsultanta: przesłania wyników badania na stację diagnostyczną.
\end{enumerate}

Węzeł lokalny musi mieć interfejs HL7 służący do komunikacji z systemami RIS. Interfejs musi mieć funkcjonalność potrzebną do zlecania opisu badań z poziomu systemu RIS oraz przekazywania gotowych opisów do systemu RIS. Interfejs musi być dokładnie opisany, tak aby podmioty trzecie mogły dostosować swoje systemy do korzystania z tego interfejsu. Dodatkowo interfejs w miarę możliwości powinien być tak zaprojektowany, aby nie sprawiał zbędnych trudności przy integracji z takimi systemami jak: TODO lista systemów, - Lista placówek - kbogu, dowiedzieć się Ragał Maciej, Kbogu. 

Pozyskiwanie danych z systemu PACS musi odbywać się na 2 sposoby:
\begin{enumerate}
  \item aktywne odpytanie systemu PACS i pobranie plików do bufora na węźle lokalnym,
  \item pasywne oczekiwanie na dostarczenie plików przez PACS lub inny węzeł DICOM; dostarczone pliki zapisywane są w buforze na węźle lokalnym.
\end{enumerate}

\section{Konfigurowalność}
\label{zlecenia-konfig}

Administrator węzła lokalnego musi mieć możliwość konfigurowania w prosty sposób następujących parametrów systemu:
\begin{enumerate}
\item definicje pakietów usług
  \begin{enumerate}
   \item lista węzłów konsultantów -- lista ta determinuje, które węzły będą mogły pobrać zlecenie do opisu; kolejność węzłów na liście ma znaczenie i wg tej kolejności zlecenie jest wysyłane do węzłów (chyba, że pakiet umożliwia użytkownikowi wybranie preferowanego konsultanta),
   \item obsługiwane kody badania,
   \item czas na zrealizowanie zlecenia,
   \item czy zleceniodawca może wybrać preferowanego konsultanta,
   \item czy zlecenie ma się pojawić u wszystkich konsultantów,
   \item jakie są możliwe przedłużenia czasu.
  \end{enumerate}


\end{enumerate}


%--------------------------------------------------------------------------------------------
%--------------------------------------------------------------------------------------------
\chapter[Podsystem Elektronicznej Wymiany Danych Medycznych]{Wymagana funkcjonalność Podsystemu Elektronicznej Wymiany Danych Medycznych}

\section{Definicje}
\begin{description}
\item[Użytkownik] Uprawniony pracownik jednostki medycznej posiadającej węzeł lokalny, który chce pozyskać dane
      medyczne dostępne w innych jednostkach medycznych.
\item[Dane medyczne] Wyniki badań medycznych pacjentów oraz ich opisy przechowywane w LSS.
\item[Identyfikator pacjenta] Identyfikator pacjenta używany w LSS. Identyfikator pacjenta zawsze występuje w kontekście
      konkretnego LSS, a bez niego nie ma znaczenia.
\item[Baza powiązań identyfikatorów] Baza danych wiążąca identyfikatory pacjentów z różnych LSS. Istnienie powiązania identyfikatorów jest jednocześnie wskazaniem, na istnienie badań medycznych w różnych węzłach lokalnych dotyczących tego samego pacjenta.
\item[Repozytorium opisów] Moduł odpowiedzialny za zbieranie, przechowywanie i aktualizację opisów badań.
\item[Moduł udostępniania opisów] Moduł pracujący w węźle lokalnym, którego zadaniem jest dostarczanie opisów badań.
\end{description}

\section{Wymagania ogólne}

\section{Schematy działania}

Działanie Bazy Metadanych musi uwzględniać obsługę niżej opisanych schematów działania.

\subsection{Interfejs użytkownika - wyszukiwanie}
\begin{enumerate}
  \item Użytkownik uwierzytelnia się w systemie i uzyskuje dostęp do interfejsu użytkownika.

    Uwierzytelnienie (logowanie) może odbywać się za pomocą loginu i hasła lub certyfikatu X.509 
    (zaimplementowane mają być obie metody). Bez uwierzytelnienia się użytkownika nie ma dostępu do
    żadnych funkcji ani informacji dostępnych w systemie, poza informacją o sposobie skontaktowania
    się z lokalnym administratorem.

  \item Użytkownik wprowadza do węzła lokalnego dane osobowe pacjenta, którego dane medyczne są poszukiwane.

        Wymagane jest, aby użytkownik wprowadził 3 dane: imię, nazwisko oraz datę urodzenia lub PESEL.
        Data musi być wprowadzana w formacie ISO 8601 i poddawana weryfikacji. PESEL również musi być
        poddawany weryfikacji włącznie ze sprawdzeniem cyfry kontrolnej.
  
  \item Użytkownik jednym przyciskiem zatwierdza wprowadzone dane, rozpoczyna procedurę wyszukiwania danych i przenosi się na ekran prezentacji wyników.

        Zbieranie odpowiedzi na zapytanie odbywa się w tle. Uzyskane odpowiedzi są na bieżąco prezentowane na ekranie wyników bez oczekiwania na zakończenie całej procedury wyszukiwania. W trakcie zbierania odpowiedzi interfejs użytkownika nie jest zablokowany i użytkownik może przeglądać wyniki, które na bieżąco się pojawiają. Użytkownik może za pomocą przycisku przerwać procedurę wyszukiwania. Przerwanie procedury wyszukiwania nie wpływa na otrzymane już wyniki, a jedynie zatrzymuje dalsze odpytywanie.
  
\end{enumerate}

\subsection{Węzły - wyszukiwanie}

Aby spełnić wymagania funkcjonalne, węzły mogą się komunikować np. w poniżej opisany sposób.
Definicje symboli użytych w opisie:
\begin{description}
  \item[\bm{$C$}] Węzeł centralny
  \item[\bm{$L_S$}] Węzeł szukający danych
  \item[\bm{$L_N$}] Dowolny, zdalny względem $L_S$, węzeł lokalny o numerze $N$
  \item[\bm{$P_{SA}ID$}] Identyfikator pacjenta $A$, jakim posługuje się węzeł szukający $L_S$
  \item[\bm{$P_{NA}ID$}] Identyfikator pacjenta $A$, jakim posługuje się węzeł odpowiadający $L_N$.
\end{description}

Identyfikator pacjenta składa się z trzech elementów: identyfikatora węzła lokalnego, identyfikatora LSS i identyfikatora
pacjenta w podanym LSS. Identyfikator pacjenta może być zapisany w postaci URI, a zapytanie HTTP GET na
ten URI z dodanymi na końcu ustalonymi etykietami powinno dać w wyniku dane osobowe pacjenta lub listę badań.
  
Przebieg procesu komunikacji:
\begin{enumerate}
  \item Użytkownik wprowadza dane osobowe pacjenta poprzez interfejs użytkownika na $L_S$.
  \item $L_S$, przeszukując podłączone do siebie LSS, tworzy $P_{SA}ID$.

  Jeśli $L_S$ w podłączonych do siebie LSS nie znajdzie danych szukanego pacjenta, to tworzy on $P_{SA}ID$ podając siebie jako LSS i generując nowy, tymczasowy, unikalny ID pacjenta. To ID pacjenta jest przechowywane na węźle przynajmniej do czasu zakończenia wyszukiwania.
  
  \item $L_S$ wysyła zapytanie o $P_{SA}ID$ do $C$.
  \item $C$ przeszukuje swoją bazę informacji powiązań identyfikatorów i w odpowiedzi wysyła:
    \begin{enumerate}
      \item listę $P_{NA}ID$ jeśli jakieś powiązania zostały odnalezione, oraz
      \item listę $L_N$, które $L_S$ powinno odpytać, ponieważ nie wiadomo, czy nie pojawiły się tam dane pacjenta.
    \end{enumerate}
  \item Jeśli $C$ odpowiedziało listą $L_N$ do odpytania, to $L_S$ odpytuje je równolegle o listę $P_{NA}ID$, podając w zapytaniu dane osobowe pacjenta oraz $P_{SA}ID$.
  \item Za każdym razem kiedy $L_S$ otrzymuje nowe $P_{NA}ID$, odpytuje powiązane z nim $L_N$ o dostępne dane medyczne i bezpośrednio po otrzymaniu odpowiedzi prezentuje je użytkownikowi.
  \item Za każdym razem kiedy odpytane $L_N$ znajdzie u siebie pacjenta o odpowiednich danych osobowych, to wysyła do $C$ powiadomienie o dopasowaniu $P_{SA}ID$ z $P_{NA}ID$.
  \item $C$ na podstawie powiadomień o powiązaniu $P_{SA}ID$ z $P_{NA}ID$ otrzymywanych od $L_N$ buduje bazę powiązań identyfikatorów.
  \item Jeśli nastąpiło dopasowanie identyfikatorów pacjenta w różnych LSS, a po przesłaniu jego danych osobowych okazuje się, że są one różne, to użytkownik powinien być o tym wyraźnie poinformowany, a administrator węzła, na którym wykryto różnice, powinien dostać zgłoszenie obsługi niewłaściwych danych. W ramach obsługi zgłoszenia niewłaściwych danych administrator powinien mieć możliwość usunięcia błędnego powiązania z bazy w węźle centralnym.
  \item Jeśli dane osobowe wprowadzone przy wyszukiwaniu pacjenta różnią się od danych osobowych zawartych w danych medycznych udostępnionych przez $L_N$, to w zależności od istotności różnic, $L_S$ będzie reagował w następujący sposób:
   \begin{enumerate}
      \item zgodność pól: imię, nazwisko; niezgodność pól: PESEL lub data urodzenia; akcja: użytkownik powinien być o tym wyraźnie poinformowany, a administrator węzła, na którym wykryto różnice powinien dostać zgłoszenie obsługi niewłaściwych danych,
      \item zgodność pól: PESEL lub data urodzenia, nazwisko; niezgodność pól: imię ; akcja: użytkownik powinien być o tym wyraźnie poinformowany, a administrator węzła na którym wykryto różnice, powinien dostać zgłoszenie obsługi niewłaściwych danych,
      \item zgodność pól: PESEL lub data urodzenia, imię; niezgodność pól: nazwisko ; akcja: użytkownik powinien być o tym wyraźnie poinformowany,
      \item niezgodność co najmniej dwóch pól; akcja: użytkownik powinien być o tym wyraźnie poinformowany, a administrator węzła na którym wykryto różnice powinien dostać zgłoszenie obsługi niewłaściwych danych.
   \end{enumerate}
  \item Jeśli dane osobowe wprowadzone przy wyszukiwaniu pacjenta różnią się od danych osobowych zawartych w danych medycznych udostępnionych przez $L_N$, to w zależności od istotności różnic $L_S$ będzie sprawdzał stopień dopasowania pól, w których występują różnice. Jeżeli stopień dopasowania jest odpowiednio wysoki (np. brak jednej litery w jednym z pól) to $L_N$ powinien o tym wyraźnie poinformować użytkownika, a administrator węzła, na którym wykryto różnice, powinien dostać zgłoszenie obsługi niewłaściwych danych.
\end{enumerate}

\section{Dostęp do opisów badań}

Ze względu na utrudnienia w integracji Systemu z LSS typu RIS i HIS, które zwykle przechowują opisy badań, należy stworzyć dwa moduły realizujące dostęp do opisów badań przechowywanych w LSS i niedostępnych poprzez DICOM. Te moduły to:
\begin{description}
  \item[Repozytorium opisów] Moduł odpowiedzialny za zbieranie, przechowywanie i aktualizację wyników badań. W sytuacji, gdy system RIS/HIS nie udostępnia wyników badań URI, wyniki badań są zbierane w repozytorium opisów. Wyniki badań i ich aktualizacje są przesyłane do repozytorium opisów w komunikatach HL7 przez systemy RIS/HIS. Repozytorium opisów przechowuje informacje o zarejestrowaniu pacjenta, zarejestrowaniu badania, statusie badania, wyniku badania. Repozytorium opisów można zasilić wynikami badań poprzez zbiorcze wysłanie wyników badań z systemu RIS/HIS do repozytorium opisów.
  \item[Moduł udostępniania opisów] Moduł działa na węźle lokalnym i jego zadaniem jest udostępnienie dla tego węzła wyników badań. Wyniki badań mogą znajdować się w systemach RIS/HIS lub być dostępne w lokalnym repozytorium opisów. Moduł umożliwia dostęp do wyników badań poprzez HTTP zgodnie z filozofią REST. Opisy muszą mieć ustandaryzowaną strukturę i być możliwe do pobrania w następujących formatach: HTML czytelny dla człowieka po wyświetleniu w przeglądarce WWW, XML, JSON. Moduł udostępniania opisów w węźle lokalnym pobiera wyniki badań w celu ich udostępnienia w następujący sposób:
  \begin{enumerate}
    \item przez przekierowanie zapytania o wynik badania bezpośrednio do lokalnego systemu RIS/HIS z użyciem URI, jeżeli system RIS/HIS oferuje taką funkcjonalność,
    \item przez odczytanie wyniku badania z lokalnego repozytorium opisów utworzonego na podstawie danych otrzymywanych z LSS (HIS, RIS).
  \end{enumerate}

\end{description}

\section{Komunikacja z LSS za pomocą protokołu HL7}

W celu dostępu do opisów badań może być konieczna komunikacja z LSS za pomocą protokołu HL7. Obsługiwane powinny być poniżej wymienione scenariusze.

\subsection{Z LSS (RIS/HIS) do repozytorium opisów}

\begin{enumerate}
  \item System RIS/HIS wysyła komunikat do repozytorium opisów z informacją o zarejestrowaniu pacjenta, komunikat HL7 ADT A01. Na podstawie rejestracji zarejestrowania pacjenta węzeł lokalny może rozpocząć procedurę wyszukiwania badań pacjenta w innych węzłach lokalnych.
  \item System RIS/HIS wysyła komunikat do repozytorium opisów komunikaty HL7 ORM O01 z informacją o:
    \begin{enumerate}
      \item zarejestrowaniu badania,
      \item rozpoczęciu badania,
      \item zakończeniu badania.
    \end{enumerate}
  \item System RIS/HIS wysyła komunikat HL7 ORU R01 do repozytorium opisów z wynikiem badania.
\end{enumerate}

\subsection{Z repozytorium opisów do LSS (RIS/HIS)}

\begin{enumerate}
  \item Repozytorium opisów wysyła wynik do systemu RIS/HIS za pomocą komunikatu HL7 ORU R01.
  \item Repozytorium opisów umożliwia pobranie wyniku badania za pomocą mechanizmu URI.
\end{enumerate}


\section{Opis interfejsu użytkownika}

TODO

\section{Opis węzła centralnego}

Zadania węzła centralnego:
  \begin{enumerate}
    \item utrzymanie bazy informacji o danych medycznych,
    \item utrzymanie bazy powiązań identyfikatorów,
    \item routing zapytań,
    \item przyjmowanie od węzłów lokalnych informacji o dostępnych danych medycznych,
    \item przyjmowanie od węzłów lokalnych informacji o powiązaniach identyfikatorów pacjentów.
  \end{enumerate}

\section{Opis węzła lokalnego}
Zadania węzła lokalnego:
  \begin{enumerate}
    \item Udostępnianie interfejsu użytkownika niezbędnego do prowadzania danych osobowych pacjentów
          oraz przeglądania pozyskanych danych medycznych.
    \item Informowanie węzła centralnego o dostępnych w LSS danych medycznych (budowa bazy informacji o danych medycznych)
    \item Informowanie węzła centralnego o odkrytych powiązaniach między identyfikatorami pacjentów
    \item Udostępnianie danych medycznych uprawnionym zdalnym węzłom lokalnym
  \end{enumerate}

\section{Konfigurowalność}

\begin{itemize}
  \item TODO możliwość określenia zestawu zapytań wysyłanych do LSS (o jakie atrybuty i w jakiej kolejności pytamy przy szukaniu pacjenta w LSS)
\end{itemize}

TODO - Bartek i Rafał
\begin{enumerate}
\item komunikacja z istniejącymi lokalnymi systemami szpitalnymi:
  \begin{enumerate}
  \item należy założyć wykorzystanie w szpitalach oprogramowania pochodzącego od różnych dostawców i mogą się pojawić różnice nawet zapisie danych osobowych w plikach DICOM. W tym celu trzeba przewidzieć w tworzonym oprogramowaniu interfejs do tworzenia standaryzacji danych osobowych postaci jednolitej dla systemu. Same dane nie będą jednak przechowywane w węźle lokalnym – posłużą do stworzenia odwzorowania na jednoznaczny identyfikator pacjenta na poziomie systemu
  \item ma za zadanie przyjmować od oprogramowania szpitalnego informacje o zajściu zdarzenia dot.
        pacjenta (np. poprzez HL7)
  \item ma za zadanie pośredniczyć w udostępnianiu danych medycznych do innych węzłów lokalnych realizując
        ich zapytanie. W tym celu po zidentyfikowaniu pacjenta wysyła do takiego systemu linki do lokalnych
        plików (np. DICOM) z jego danymi medycznymi
  \end{enumerate}

\item komunikacja z węzłem centralnym
  \begin{enumerate}
  \item przekazywane są powiązania informacje o jednoznacznych identyfikatorach pacjentów
  \item opcjonalnie następuje synchronizacja z węzłem centralnym, o której mowa w pkt. 4.2.4.
  \end{enumerate}

\item komunikacja z innymi węzłami lokalnymi
  \begin{enumerate}
  \item udostępnianie danych medycznych pacjentów innym węzłom lokalnym jak opisane w pkt.  4.3.1.3.
  \item pobieranie danych z innych węzłów lokalnych
  \end{enumerate}

\end{enumerate}

\end{document}
